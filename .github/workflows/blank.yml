name: Build and Deploy

on:
  push:
    branches:
      - alpha.lambdax.san

    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
  EC2_USER: ${{ secrets.EC2_USER }}
  DOCKER_IMAGE_TAG: ${{ github.head_ref || github.ref_name }}


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set variables
        run: |
          if [[ $BRANCH_NAME == 'alpha.lambdax.san' ]]; then
            echo "EC2_HOSTNAME=ec2-3-84-30-29.compute-1.amazonaws.com" >> "$GITHUB_ENV"          
          fi
          echo "EC2_USER=${EC2_USER}" >> "$GITHUB_ENV"

      - name: Deploy to specified server alpha.lambdax.san
        if: startsWith(env.BRANCH_NAME, 'alpha.lambdax.san')
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          if [[ $BRANCH_NAME == 'alpha.lambdax.san' ]]; then
            echo "${{ secrets.SSH_KEY_VERTEX }}" > ~/.ssh/id_rsa
          fi
          chmod 400 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
      
      - name: Log In to Container Registry on server ${{ env.EC2_HOSTNAME }}
        if: ${{ env.BRANCH_NAME == 'alpha.lambdax.san' }}
        run: |
          set -x
          ssh -o "StrictHostKeyChecking no" -i ~/.ssh/id_rsa ${EC2_USER}@${{ env.EC2_HOSTNAME }} '(sudo touch /tmp/san.html)
