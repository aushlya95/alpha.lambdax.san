name: Build and Deploy

on:
  push:
    branches:
      - alpha.lambdax.san
      - playground.lambdax.ai

    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
  EC2_USER: ${{ secrets.EC2_USER }}
  DOCKER_IMAGE_TAG: ${{ github.head_ref || github.ref_name }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set variables
        run: |
          if [[ $BRANCH_NAME == 'alpha.lambdax.san' ]]; then
            echo "EC2_HOSTNAME=${EC2_ALPHA_HOSTNAME}" >> "$GITHUB_ENV"
          elif [[ $BRANCH_NAME == 'playground.lambdax.ai' ]]; then
            echo "EC2_HOSTNAME=${EC2_PLAYGROUND_HOSTNAME}" >> "$GITHUB_ENV"
          fi
          echo "EC2_USER=${EC2_USER}" >> "$GITHUB_ENV"

      - name: Deploy to specified server
        if: startsWith(env.BRANCH_NAME, 'alpha.lambdax.san') || startsWith(env.BRANCH_NAME, 'playground.lambdax.ai')
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_VERTEX }}" > ~/.ssh/id_rsa
          chmod 400 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa

          # Replace the placeholder command below with your actual deployment commands
          ssh -o "StrictHostKeyChecking no" -i ~/.ssh/id_rsa ${{ env.EC2_USER }}@${{ env.EC2_HOSTNAME }} "touch /tmp/santooz.html"
